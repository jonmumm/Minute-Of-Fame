<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>index</title>
	
	<script src="http://cdn.socket.io/stable/socket.io.js" type="text/javascript"></script>
	<script type="text/javascript" src="/browserify.js?simple"></script>
	<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
	
	<script>
		(function() {
	
			var commands = require('./commands');
		
			//****************************************************
			// OpenTok Functions
			//****************************************************				
			var opentokInit = function (opentok, stream_name) {
				var apiKey = opentok.apiKey;
				var sessionId = opentok.sessionId
				var token = opentok.token;
			
				TB.addEventListener("exception", exceptionHandler);

				if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
					alert("You don't have the minimum requirements to run this application."
						  + "Please upgrade to the latest version of Flash.");
				} else {
					// Initialize the session
					session = TB.initSession(sessionId);

					// Add event listeners to the session
					session.addEventListener('sessionConnected', sessionConnectedHandler);
					session.addEventListener('streamCreated', streamCreatedHandler);
					session.addEventListener('streamDestroyed', streamDestroyedHandler);
				}
				
				session.connect(apiKey, token);		
			}
		
			var sessionConnectedHandler = function (event) {
				// Publish my stream to the session
				publishStream();
			
				// Subscribe to all streams currently in the Session
				subscribeToStreams(event.streams);
			}

			var streamCreatedHandler = function (event) {
				// Subscribe to the newly created streams
				subscribeToStreams(event.streams);
			}

			var streamDestroyedHandler = function (event) {	
				// Get all destroyed streams		
				for (var i = 0; i < event.streams.length; i++) {
					// For each stream get the subscriber to that stream
					var subscribers = session.getSubscribersForStream(event.streams[i]);
					for (var j = 0; j < subscribers.length; j++) {
						// Then remove each stream

					}
				}
			}

			var exceptionHandler = function (event) {
				alert("Exception: " + event.code + "::" + event.message);
			}

			var publishStream = function () {
				//session.publish("stream-" + myTeam.id, { name: myTeam.name });
			}

			var subscribeToStreams = function (streams) {
				for (var i = 0; i < streams.length; i++) {
					var stream = streams[i];
					if (stream.connection.connectionId != session.connection.connectionId) {
					//	var divId = "stream-" + findTeamIdByName(stream.name);
							//session.subscribe(stream, divId);
					}
				}
			}
					
			//****************************************************
			// Socket.io Initialization
			//****************************************************				
			var socket = new io.Socket(null, {port: 7000, rememberTransport: false});
		
			// Build and send the initial command
			(function() {
				socket.on("message", messageHandler);
				socket.connect();
			
				function messageHandler(message) {
					if (commands.validate(message)) {
						commands.run(message);
					} else {
						alert("Invalid command received from server.");
					}
				}
			})();
		})();

	</script>
	
</head>


<body>
<h1>Minute Of Fame</h1>

	<div id="container">

	</div>
	
</body>
</html>
