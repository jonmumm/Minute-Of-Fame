<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>index</title>
	
	<script src="http://cdn.socket.io/stable/socket.io.js" type="text/javascript"></script>
	<script type="text/javascript" src="/browserify.js?simple"></script>
	<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript"></script>
	<script src="js/jquery-1.5.1.min.js" type="text/javascript"></script>
	<script src="js/jquery-ui-1.8.12.custom.min.js" type="text/javascript"></script>
	
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.3.0/build/cssreset/reset-min.css">
	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<link rel="Stylesheet" type="text/css" href="css/start/jquery-ui-1.8.12.custom.css"/>	
	
	<script>

		var commands = require('./commands');
		
		var opentok;
		
		var me;
		var queue;
		
		var opentok;
		
		var stream;
		
		var cameraAllowed = false;
		
		//****************************************************
		// Session Command Receivers
		//****************************************************
		var sessionCommands = {
			join: sessionJoin,
		}
		commands.inject("session", sessionCommands);

		function sessionJoin(params) {
			var performance = params.performance;
			opentok = params.opentok;
			queue = params.queue;
			me = params.user;
			
			for (var i = 0; i < queue.length; i++) {
				queueAddUserToDisplay(queue[i]);
			}
			
			opentokInit(opentok);
		}
		
		//****************************************************
		// Performance Command Receivers
		//****************************************************
		var performanceCommands = {
			start: performanceStart,
			end: performanceEnd,
		}
		commands.inject("performance", performanceCommands);

		function performanceStart(params) {
			var performance = params.performance;			
		}
		
		function performanceEnd(params) {
			var performance = params.performance;
		}
		
		//****************************************************
		// Queue Command Receivers
		//****************************************************
		var queueCommands = {
			join: queueJoin,
			leave: queueLeave,
			next: queueNext,
		}
		commands.inject("queue", queueCommands);
		
		function queueJoin(params) {
			var user = params.user;
			
			queueAddUserToDisplay(user);
			
			queue.push(user);
		}
		
		function queueLeave(params) {
			var user = params.user;
			
			$("#queue-" + user.id).remove();
		}
		
		function queueNext(params) {
			stageEnter();
		}
		
		//****************************************************
		// Queue Command Senders
		//****************************************************
		function meQueueJoin(name) {
			me.name = name;
			
			var command = {
				type: "queue",
				action: "join",
				params: {
					user: me,
				}
			}
			
			socket.send(command);
			
			$("#queueButton").unbind("click");
			$("#queueButton").bind("click", meQueueLeave);
			$("#queueButton").attr("Value", "Leave Queue");
		}
		
		function meQueueLeave() {
			var command = {
				type: "queue",
				action: "leave",
				params: {
					user: me
				}
			}
			
			socket.send(command);
			
			$("#queueButton").unbind("click");
			$("#queueButton").bind("click", meQueueJoin);
			$("#queueButton").attr("Value", "Join Queue");
		}
		
		//****************************************************
		// Queue Helper Methods
		//****************************************************
		function queueAddUserToDisplay(user) {
			var li = $("<li/>", {
				id: "queue-" + user.id,
				text: user.id,
			});

			li.appendTo(".queue ol");			
		}
		
		//****************************************************
		// Stage Command Receivers
		//****************************************************
		var stageCommands = {
			enter: stageEnter,
			check: stageCheck,
			// checkTimer: stageCheckTimer
		}
		commands.inject("stage", stageCommands);
		
		function stageCheck(params) {
			var ready = cameraAllowed;

			stageStatus(ready);
			
			// stageLeave();
		}
		
		/*
		function stageCheckTimer(params) {
			var user = params.user;
			
			if (me.id == user.id) {
				
			} else {
				
			}
			
			// Start some timer
		}*/
		
		//****************************************************
		// stage Command Senders
		//****************************************************
		function stageStatus(ready) {
			var command = {
				type: "stage",
				action: "status",
				params: {
					ready: ready,
				}
			}
			
			socket.send(command);
		}			
		
		//****************************************************
		// stage Helper Functions
		//****************************************************		
		function stageEnter() {			
			$("#stageDialog").dialog({
				autoopen: false,
				title: "stage",
				closeOnEscape: false,
				open: function(event, ui) { $(".ui-dialog-titlebar-close").hide(); },
				height: 300,
				width: 400,
				// resize: function(event, ui) { console.log(event); },
			});
			
			var publisher = session.publish("stagePublisher");
			
			$("#stageDialog").dialog('open');
			//$("#" + publisher.id).attr("width", "100%");
			//$("#" + publisher.id).attr(width, "100%");
			//$("#" + publisher.id).removeAttr(width);
			//$("#" + publisher.id).removeAttr(width);
			
			//$("#" + publisher.id).width = 800;
			
			/*
			var obj = document.getElementById(publisher.id);
			obj.width = 800;
			obj.height = 800; */
			//console.log(obj);
			
			setTimeout(stageLeave, 10000);
		}
		
		function stageLeave() {			
			// $("#stageContainer").hide('slow');
			//var dialog = $("#stageDialog").dialog('widget')[0];
			//$(dialog).removeClass('ui-draggable');
			//$(dialog).removeClass('ui-resizable');
			//$("#stageDialog").dialog('close');
			//$("#stageDialog").dialog('open');
			
		}
		
		function stageResizeVideo() {
			
		}
	
		//****************************************************
		// OpenTok Functions
		//****************************************************
		var session;
						
		var opentokInit = function (opentok) {
			var apiKey = opentok.apiKey;
			var sessionId = opentok.sessionId
			var token = opentok.token;
		
			TB.addEventListener("exception", exceptionHandler);

			if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
				alert("You don't have the minimum requirements to run this application."
					  + "Please upgrade to the latest version of Flash.");
			} else {
				// Initialize the session
				session = TB.initSession(sessionId);

				// Add event listeners to the session
				session.addEventListener('sessionConnected', sessionConnectedHandler);
				session.addEventListener('streamCreated', streamCreatedHandler);
				session.addEventListener('streamDestroyed', streamDestroyedHandler);
			}
			
			session.connect(apiKey, token);		
		}
	
		var sessionConnectedHandler = function (event) {
			// TODO: Enable queue join button, move this logic not in opentok section (add another session connect handler)
			$("#queueButton").attr('disabled', '');
			
			
			me.connectionId = session.connection.connectionId;
			
			// Publish my stream to the session
			// publishStream();
		
			// Subscribe to all streams currently in the Session
			// subscribeToStreams(event.streams);
		}

		var streamCreatedHandler = function (event) {
			for (var i = 0; i < event.streams.length; i++) {
				if (event.streams[i].connection.connectionId != session.connection.connectionId) {
					stream = stream[i];
				} else {
					cameraAllowed = true;
				}
			}			
						
			// Subscribe to the newly created streams
			// subscribeToStreams(event.streams);
		}

		var streamDestroyedHandler = function (event) {	
			// Get all destroyed streams		
			for (var i = 0; i < event.streams.length; i++) {
				// For each stream get the subscriber to that stream
				var subscribers = session.getSubscribersForStream(event.streams[i]);
				for (var j = 0; j < subscribers.length; j++) {
					// Then remove each stream

				}
			}
		}

		var exceptionHandler = function (event) {
			alert("Exception: " + event.code + "::" + event.message);
		}

		var publishStream = function () {
			//session.publish("stream-" + myTeam.id, { name: myTeam.name });
		}

		var subscribeToStreams = function (streams) {
			for (var i = 0; i < streams.length; i++) {
				var stream = streams[i];
				if (stream.connection.connectionId != session.connection.connectionId) {
				//	var divId = "stream-" + findTeamIdByName(stream.name);
						//session.subscribe(stream, divId);
				}
			}
		}
				
		//****************************************************
		// Socket.io Initialization
		//****************************************************				
		var socket = new io.Socket(null, {port: 7000, rememberTransport: false});
	
		// Build and send the initial command
		(function() {
			socket.on("message", messageHandler);
			socket.connect();
		
			function messageHandler(message) {
				if (commands.validate(message)) {
					commands.run(message);
				} else {
					alert("Invalid command received from server.");
				}
			}
			

		})();
		
		$(window).load(function() {
			$("#queueButton").button( {
				label: "Join Queue",
			});
			$("#queueButton").bind('click', function() {
				$("#joinQueueDialog").dialog( {
					title: "Join Queue",
					resizable: false,
					buttons: {
						"Join": function() {
							// TODO: Validate
							
							// Enter Queue
							var name = $("#name").val();
							
							meQueueJoin(name);
							$(this).dialog("close");
						},
						"Cancel": function() {
							$(this).dialog("close");
						}
					},
				});
			});
		});
	

	</script>
	
</head>


<body>
	<div id="page-container">
		<div id="header"></div>
		<div id="content">
			<div id="sidebar-left"></div>
			<div id="main">
				<div id="publisher-container">
					<div id="publisher"></div>
				</div>
				<div id="description"></div>				
			</div>
			<div id="sidebar-right">
				<h3>Queue</h3>
				<button id="queueButton"></button>
			</div>
		</div>
		

		<div class="queue">
			<h2>Queue</h2>
			
			<ol>
			</ol>
		</div>
	</div>
	
	<div id="joinQueueDialog" style="display: none;">
		<p class="validateTips">All form fields are required.</p>
		<form>
			<fieldset>
				<label for="name">Name</label>
				<input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all">
			</fieldset>
		</form>
	</div>
	
	<div id="stageDialog" style="display: none; width: 100%; height: 100%">
		<h2>You are up next</h2>
		<div id="sstagetagePublisher"></div>
	</div>
	
</body>
</html>
