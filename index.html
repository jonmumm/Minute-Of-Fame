<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>index</title>
	
	<script src="http://cdn.socket.io/stable/socket.io.js" type="text/javascript"></script>
	<script type="text/javascript" src="/browserify.js?simple"></script>
	<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
	
	<script>

		var commands = require('./commands');
		
		var opentok;
		
		var me;	
		var queue;
		
		var opentok;
		
		var stream;
		
		var cameraAllowed = false;
		
		//****************************************************
		// Session Command Receivers
		//****************************************************
		var sessionCommands = {
			join: sessionJoin,
		}
		commands.inject("session", sessionCommands);

		function sessionJoin(params) {
			var performance = params.performance;
			opentok = params.opentok;
			queue = params.queue;
			me = params.user;
			
			for (var i = 0; i < queue.length; i++) {
				queueAddUserToDisplay(queue[i]);
			}
			
			opentokInit(opentok);
		}
		
		//****************************************************
		// Performance Command Receivers
		//****************************************************
		var performanceCommands = {
			start: performanceStart,
			end: performanceEnd,
		}
		commands.inject("performance", performanceCommands);

		function performanceStart(params) {
			var performance = params.performance;			
		}
		
		function performanceEnd(params) {
			var performance = params.performance;
		}
		
		//****************************************************
		// Queue Command Receivers
		//****************************************************
		var queueCommands = {
			join: queueJoin,
			leave: queueLeave,
			next: queueNext,
		}
		commands.inject("queue", queueCommands);
		
		function queueJoin(params) {
			var user = params.user;
			
			queueAddUserToDisplay(user);
			
			queue.push(user);
		}
		
		function queueLeave(params) {
			var user = params.user;
			
			$("#queue-" + user.id).remove();
		}
		
		function queueNext(params) {
			backstageEnter();
		}
		
		//****************************************************
		// Queue Command Senders
		//****************************************************
		function meQueueJoin() {
			var command = {
				type: "queue",
				action: "join",
				params: {
					user: me,
				}
			}
			
			socket.send(command);
			
			$("#queueButton").unbind("click");
			$("#queueButton").bind("click", meQueueLeave);
			$("#queueButton").attr("Value", "Leave Queue");
		}
		
		function meQueueLeave() {
			var command = {
				type: "queue",
				action: "leave",
				params: {
					user: me
				}
			}
			
			socket.send(command);
			
			$("#queueButton").unbind("click");
			$("#queueButton").bind("click", meQueueJoin);
			$("#queueButton").attr("Value", "Join Queue");
		}
		
		//****************************************************
		// Queue Helper Methods
		//****************************************************
		function queueAddUserToDisplay(user) {
			var li = $("<li/>", {
				id: "queue-" + user.id,
				text: user.id,
			});

			li.appendTo(".queue ol");			
		}
		
		//****************************************************
		// Backstage Command Receivers
		//****************************************************
		var backstageCommands = {
			check: backstageCheck,
			checkTimer: backstageCheckTimer
		}
		commands.inject("backstage", backstageCommands);
		
		function backstageCheck(params) {
			var ready = cameraAllowed;

			backstageStatus(ready);
			
			backstageLeave();
		}
		
		function backstageCheckTimer(params) {
			var user = params.user;
			
			if (me.id == user.id) {
				
			} else {
				
			}
			
			// Start some timer
		}
		
		//****************************************************
		// Backstage Command Senders
		//****************************************************
		function backstageStatus(ready) {
			var command = {
				type: "backstage",
				action: "status",
				params: {
					ready: ready,
				}
			}
			
			socket.send(command);
		}			
		
		//****************************************************
		// Backstage Helper Functions
		//****************************************************		
		function backstageEnter() {			
			$("#backstageContainer").show('slow');
			
			session.publish("publisher");
		}
		
		function backstageLeave() {			
			$("#backstageContainer").hide('slow');
		}
	
		//****************************************************
		// OpenTok Functions
		//****************************************************
		var session;
						
		var opentokInit = function (opentok) {
			var apiKey = opentok.apiKey;
			var sessionId = opentok.sessionId
			var token = opentok.token;
		
			TB.addEventListener("exception", exceptionHandler);

			if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
				alert("You don't have the minimum requirements to run this application."
					  + "Please upgrade to the latest version of Flash.");
			} else {
				// Initialize the session
				session = TB.initSession(sessionId);

				// Add event listeners to the session
				session.addEventListener('sessionConnected', sessionConnectedHandler);
				session.addEventListener('streamCreated', streamCreatedHandler);
				session.addEventListener('streamDestroyed', streamDestroyedHandler);
			}
			
			session.connect(apiKey, token);		
		}
	
		var sessionConnectedHandler = function (event) {
			// TODO: Enable queue join button, move this logic not in opentok section (add another session connect handler)
			$("#queueButton").attr('disabled', '');
			$("#queueButton").bind('click', meQueueJoin);
			
			me.connectionId = session.connection.connectionId;
			
			// Publish my stream to the session
			// publishStream();
		
			// Subscribe to all streams currently in the Session
			// subscribeToStreams(event.streams);
		}

		var streamCreatedHandler = function (event) {
			for (var i = 0; i < event.streams.length; i++) {
				if (event.streams[i].connection.connectionId != session.connection.connectionId) {
					stream = stream[i];
				} else {
					cameraAllowed = true;
				}
			}			
						
			// Subscribe to the newly created streams
			// subscribeToStreams(event.streams);
		}

		var streamDestroyedHandler = function (event) {	
			// Get all destroyed streams		
			for (var i = 0; i < event.streams.length; i++) {
				// For each stream get the subscriber to that stream
				var subscribers = session.getSubscribersForStream(event.streams[i]);
				for (var j = 0; j < subscribers.length; j++) {
					// Then remove each stream

				}
			}
		}

		var exceptionHandler = function (event) {
			alert("Exception: " + event.code + "::" + event.message);
		}

		var publishStream = function () {
			//session.publish("stream-" + myTeam.id, { name: myTeam.name });
		}

		var subscribeToStreams = function (streams) {
			for (var i = 0; i < streams.length; i++) {
				var stream = streams[i];
				if (stream.connection.connectionId != session.connection.connectionId) {
				//	var divId = "stream-" + findTeamIdByName(stream.name);
						//session.subscribe(stream, divId);
				}
			}
		}
				
		//****************************************************
		// Socket.io Initialization
		//****************************************************				
		var socket = new io.Socket(null, {port: 7000, rememberTransport: false});
	
		// Build and send the initial command
		(function() {
			socket.on("message", messageHandler);
			socket.connect();
		
			function messageHandler(message) {
				if (commands.validate(message)) {
					commands.run(message);
				} else {
					alert("Invalid command received from server.");
				}
			}
			

		})();
	

	</script>
	
</head>


<body>
<h1>Minute Of Fame</h1>

	<div id="container">
		<div id="publisher"></div>
		<div id="backstageContainer" style="display: none;">
			<h2>Backstage</h2>
		</div>
		<div class="queue">
			<h2>Queue</h2>
			<input type="button" id="queueButton" value="Join Queue" disabled="disabled"/>
			<ol>
			</ol>
		</div>
	</div>
	
</body>
</html>
